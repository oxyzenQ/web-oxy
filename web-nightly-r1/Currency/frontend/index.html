<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- CSP will be set dynamically by JavaScript based on environment -->
    <!-- Fonts and icons are loaded via JavaScript modules for CSP compliance -->
    <link rel="stylesheet" href="style.css">
    <link rel="icon" href="assets/kconvert-logo-orig.webp" type="image/webp">
    <title>A simple & fast currency converter</title>
</head>

<body>
    <div class="container">
        <!-- Animated Logo Header -->
        <div class="brand">
            <div class="brand-ring ring-outer"></div>
            <div class="brand-ring ring-gold"></div>
            <div class="brand-ring ring-inner"></div>
            <div class="brand-logo">
                <img src="assets/kconvert-logo-orig.webp" alt="Kconvert logo" />
            </div>
        </div>
        <h2 class="app-title">Kconvert App</h2>
        <p class="app-subtitle">A app for currency converter</p>
        <div class="A">
            <p>Amount</p>
        </div>
        <form id="converter-form">
            <div class="amount">
                <input type="text" id="amount-input" class="form1"
                aria-label="Amount to convert" placeholder="Enter amount" autocomplete="off">
            </div>

            <div class="convert-box">
                <div class="from">
                    <p>From</p>
                    <div class="search-input-container" data-type="from">
                        <img id="from-flag" src="https://flagcdn.com/48x36/us.png" alt="From currency flag" class="flag-indicator">
                        <input type="text" class="currency-search from-search form2" 
                               placeholder="USD - United States Dollar" 
                               aria-label="Search from currency"
                               data-currency="USD"
                               data-full-name="USD - United States Dollar"
                               autocomplete="off"
                               readonly>
                        <div class="search-suggestions from-suggestions" style="display: none;"></div>
                    </div>
                </div>
                <div class="reverse" aria-label="Swap currencies">
                    <i class="fas fa-exchange-alt"></i>
                </div>
                <div class="to">
                    <p>To</p>
                    <div class="search-input-container" data-type="to">
                        <img id="to-flag" src="https://flagcdn.com/48x36/sg.png" alt="To currency flag" class="flag-indicator">
                        <input type="text" class="currency-search to-search form3" 
                               placeholder="SGD - Singapore Dollar" 
                               aria-label="Search to currency"
                               data-currency="SGD"
                               data-full-name="SGD - Singapore Dollar"
                               autocomplete="off"
                               readonly>
                        <div class="search-suggestions to-suggestions" style="display: none;"></div>
                    </div>
                </div>
                <div class="result" aria-live="polite">Ready to convert</div>
                <!-- Inline help icon (opens floating modal with instructions) -->
                <span id="help-icon" class="info-help-icon" aria-label="Show usage help" tabindex="0">?</span>
                <button type="submit" id="convert-button"><i class="fas fa-arrow-right"></i><span>Convert</span></button>
                <button type="reset" id="reset-button"><i class="fas fa-rotate-left"></i><span>Reset</span></button> <!-- Keep inside container -->
            </div>
        </form>
    </div>

    <!-- Second Container: Chart Graphics -->
    <div class="container chart-container">
        <h2 class="section-title">Exchange Rate Chart</h2>
        <div class="chart-controls">
            <button class="time-range-btn active" data-range="12H">12H</button>
            <button class="time-range-btn" data-range="1D">1D</button>
            <button class="time-range-btn" data-range="1W">1W</button>
            <button class="time-range-btn" data-range="1M">1M</button>
            <button class="time-range-btn" data-range="1Y">1Y</button>
            <button class="time-range-btn" data-range="2Y">2Y</button>
            <button class="time-range-btn" data-range="5Y">5Y</button>
            <button class="time-range-btn" data-range="10Y">10Y</button>
        </div>
        <div class="chart-wrapper">
            <canvas id="exchangeRateChart"></canvas>
        </div>
        <div class="chart-info">
            <div class="chart-currency-pair">
                <span class="chart-from">--</span>
                <i class="fas fa-arrow-right"></i>
                <span class="chart-to">--</span>
            </div>
            <div class="chart-current-rate">0.000000</div>
        </div>
    </div>

    <!-- Third Container: What is converter? -->
    <div class="container info-container">
        <h2 class="section-title">What is converter?</h2>
        <div class="section-content">
            <p>A currency converter is an essential financial tool that allows users to calculate the equivalent value of one currency in terms of another currency. This powerful utility uses real-time exchange rates from global financial markets to provide accurate conversions between different international currencies. Whether you're planning international travel, conducting business across borders, making online purchases from foreign retailers, or simply staying informed about global economic trends, a currency converter serves as your gateway to understanding monetary values worldwide. Modern currency converters leverage advanced APIs and financial data sources to ensure precision and reliability, making complex foreign exchange calculations accessible to everyone from casual travelers to professional traders and international business professionals.</p>
        </div>
    </div>

    <!-- Four Container: About Kconvert App -->
    <div class="container about-container">
        <h2 class="section-title">About the Kconvert app</h2>
        <div class="section-content">
            <p>Is an app for converter, not like traditional other, this project apps to make simple but modern look that function, this project leader by Team 6. with license MIT you can use, modify, and distribute this software freely. The project emphasizes clean design principles, user-friendly interfaces, and reliable functionality while maintaining open-source accessibility for developers worldwide.</p>
            
            <div class="project-info">
                <div class="info-item">
                    <i class="fas fa-tag"></i>
                    <span class="info-label">Version:</span>
                    <span class="info-value">Stellar-1.5</span>
                </div>
                <div class="info-item">
                    <i class="fas fa-code-branch"></i>
                    <span class="info-label">Type Apps:</span>
                    <span class="info-value">Creativity Project</span>
                </div>
                <div class="info-item">
                    <i class="fas fa-wrench"></i>
                    <span class="info-label">Status:</span>
                    <span class="info-value">Maintenance</span>
                </div>
                <div class="info-item">
                    <i class="fas fa-balance-scale"></i>
                    <span class="info-label">License:</span>
                    <span class="info-value">MIT</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Currency Search Modal -->
    <div class="search-modal-backdrop" id="search-backdrop"></div>
    <div class="currency-search-modal" id="currency-modal">
        <div class="search-modal-header">
            <input type="text" class="search-modal-input" id="modal-search-input" placeholder="Search currency (e.g. US, America, USD)..." autocomplete="off">
            <button class="modal-close-btn" id="modal-close-btn" aria-label="Close currency search">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="search-modal-list" id="modal-currency-list">
            <!-- Currency list will be populated by JavaScript -->
        </div>
    </div>

    <!-- Glass Notify Modal -->
    <dialog id="notify-modal" class="glass-modal">
        <div class="modal-content">
            <div class="modal-icon" aria-hidden="true"><i class="fa-solid fa-circle-question"></i></div>
            <div class="modal-text">
                <h3 id="modal-title">Warning</h3>
                <p id="modal-message">Something needs your attention.</p>
            </div>
            <div class="modal-actions">
                <button class="modal-btn" id="modal-close">Close</button>
            </div>
        </div>
    </dialog>

    <footer>
        <!--<p>
            <a class="footer-gh" href="https://github.com/oxyzenq" aria-label="GitHub profile" rel="noopener" target="_blank">
                <i class="fa-brands fa-github"></i>
            </a>
        </p> -->
        <p>&copy; 2025 Team 6. Licensed under <a class="mit" href="https://opensource.org/licenses/MIT" target="_blank" rel="noopener">MIT</a>.</p>
    </footer>

    <script type="module" src="./main.js"></script>
    <script>
      // Minimal modal close behavior to avoid blocking UX; main.js can extend this
      const modal = document.getElementById('notify-modal');
      const closeBtn = document.getElementById('modal-close');
      if (modal && closeBtn) {
        closeBtn.addEventListener('click', () => window.KconvertModal.close());
      }
      // Enhanced modal API with smooth transitions
      window.KconvertModal = {
        open({title = 'Notice', message = '', icon = 'question'} = {}) {
          document.getElementById('modal-title').textContent = title;
          document.getElementById('modal-message').textContent = message;
          const iconEl = document.querySelector('#notify-modal .modal-icon i');
          if (iconEl) {
            if (icon === 'check') {
              iconEl.className = 'fa-solid fa-circle-check';
            } else {
              iconEl.className = 'fa-solid fa-circle-question';
            }
          }
          modal.showModal();
          // Disable background scrolling
          document.body.style.overflow = 'hidden';
          document.documentElement.style.overflow = 'hidden';
        },
        close(){ 
          // Add closing animation
          modal.style.animation = 'modalSlideOut 0.3s ease-out forwards';
          setTimeout(() => {
            modal.close();
            modal.style.animation = '';
            // Restore background scrolling
            document.body.style.overflow = '';
            document.documentElement.style.overflow = '';
          }, 300);
        }
      }

      // Currency Search Modal Functionality
      const currencyModal = document.getElementById('currency-modal');
      const searchBackdrop = document.getElementById('search-backdrop');
      const modalSearchInput = document.getElementById('modal-search-input');
      const modalCurrencyList = document.getElementById('modal-currency-list');
      let currentSearchType = null;
      let currentSearchInput = null;

      // Enhanced currency data with 100+ countries - loaded from backend
      let availableCurrencies = [];
      
      // Comprehensive country code mapping for 100+ currencies
      const currencyToCountry = {
        // Major currencies
        'USD': 'us', 'EUR': 'eu', 'GBP': 'gb', 'JPY': 'jp', 'AUD': 'au', 'CAD': 'ca',
        'CHF': 'ch', 'CNY': 'cn', 'SEK': 'se', 'NZD': 'nz', 'MXN': 'mx', 'SGD': 'sg',
        'HKD': 'hk', 'NOK': 'no', 'TRY': 'tr', 'RUB': 'ru', 'INR': 'in', 'BRL': 'br',
        'ZAR': 'za', 'KRW': 'kr', 'PLN': 'pl', 'THB': 'th', 'MYR': 'my', 'AED': 'ae',
        'SAR': 'sa', 'ILS': 'il', 'CLP': 'cl', 'COP': 'co', 'ARS': 'ar', 'TWD': 'tw',
        
        // European currencies
        'DKK': 'dk', 'CZK': 'cz', 'HUF': 'hu', 'RON': 'ro', 'BGN': 'bg', 'HRK': 'hr',
        'ISK': 'is', 'ALL': 'al', 'BAM': 'ba', 'MKD': 'mk', 'RSD': 'rs', 'MDL': 'md',
        
        // Asian currencies
        'PHP': 'ph', 'IDR': 'id', 'VND': 'vn', 'KHR': 'kh', 'LAK': 'la', 'MMK': 'mm',
        'BDT': 'bd', 'PKR': 'pk', 'NPR': 'np', 'LKR': 'lk', 'MVR': 'mv', 'BTN': 'bt',
        'AFN': 'af', 'UZS': 'uz', 'KZT': 'kz', 'KGS': 'kg', 'TJS': 'tj', 'TMT': 'tm',
        'MNT': 'mn', 'KPW': 'kp', 'JPY': 'jp',
        
        // Middle Eastern currencies
        'QAR': 'qa', 'KWD': 'kw', 'BHD': 'bh', 'OMR': 'om', 'JOD': 'jo', 'LBP': 'lb',
        'SYP': 'sy', 'IQD': 'iq', 'IRR': 'ir', 'GEL': 'ge', 'AMD': 'am', 'AZN': 'az',
        
        // African currencies
        'EGP': 'eg', 'NGN': 'ng', 'KES': 'ke', 'GHS': 'gh', 'MAD': 'ma', 'TND': 'tn',
        'DZD': 'dz', 'LYD': 'ly', 'ETB': 'et', 'UGX': 'ug', 'TZS': 'tz', 'RWF': 'rw',
        'XOF': 'sn', 'XAF': 'cm', 'MGA': 'mg', 'MUR': 'mu', 'SCR': 'sc', 'SZL': 'sz',
        'LSL': 'ls', 'BWP': 'bw', 'NAD': 'na', 'ZMW': 'zm', 'ZWL': 'zw', 'MWK': 'mw',
        'MZN': 'mz', 'AOA': 'ao', 'CVE': 'cv', 'GMD': 'gm', 'GNF': 'gn', 'LRD': 'lr',
        'SLL': 'sl', 'STD': 'st', 'CDF': 'cd', 'XPF': 'pf', 'DJF': 'dj', 'ERN': 'er',
        'SOS': 'so', 'SDP': 'sd', 'SSP': 'ss',
        
        // Eastern European & CIS
        'BYN': 'by', 'UAH': 'ua', 'GEL': 'ge', 'AMD': 'am', 'AZN': 'az',
        
        // Caribbean & Pacific
        'JMD': 'jm', 'TTD': 'tt', 'BBD': 'bb', 'BSD': 'bs', 'BZD': 'bz', 'XCD': 'ag',
        'HTG': 'ht', 'DOP': 'do', 'CUP': 'cu', 'KYD': 'ky', 'AWG': 'aw', 'ANG': 'cw',
        'SRD': 'sr', 'GYD': 'gy', 'FJD': 'fj', 'TOP': 'to', 'WST': 'ws', 'VUV': 'vu',
        'SBD': 'sb', 'PGK': 'pg', 'NCX': 'nc', 'XPF': 'pf',
      };
      
      // Load currencies from backend API
      async function loadCurrencies() {
        try {
          // Hardcoded backend URL
          const currenciesUrl = 'https://kconvert-backend.zeabur.app/api/currencies';

          const response = await fetch(currenciesUrl, { headers: { 'Accept': 'application/json' } });
          const ct = response.headers.get('content-type') || '';
          if (!response.ok) {
            const text = await response.text();
            throw new Error(`HTTP ${response.status} ${response.statusText}: ${text.slice(0, 200)}...`);
          }
          if (!ct.includes('application/json')) {
            const text = await response.text();
            throw new Error(`Expected JSON but received content-type '${ct}'. Body starts with: ${text.slice(0, 200)}...`);
          }
          const data = await response.json();
          availableCurrencies = data.currencies.map(currency => ({
            code: currency.code,
            name: currency.name,
            flag: currencyToCountry[currency.code] || 'un'
          }));
          console.log(`âœ… Loaded ${availableCurrencies.length} currencies from backend`);
        } catch (error) {
          console.error('âŒ Failed to load currencies from backend:', error);
          // Fallback to basic currencies
          availableCurrencies = [
            { code: 'USD', name: 'US Dollar', flag: 'us' },
            { code: 'EUR', name: 'Euro', flag: 'eu' },
            { code: 'GBP', name: 'British Pound', flag: 'gb' },
            { code: 'JPY', name: 'Japanese Yen', flag: 'jp' },
            { code: 'SGD', name: 'Singapore Dollar', flag: 'sg' }
          ];
        }
      }

      function openCurrencyModal(type, inputElement) {
        currentSearchType = type;
        currentSearchInput = inputElement;
        
        // Prevent body scrolling when modal is open
        document.body.style.overflow = 'hidden';
        document.documentElement.style.overflow = 'hidden';
        
        currencyModal.style.display = 'flex';
        searchBackdrop.style.display = 'block';
        modalSearchInput.value = '';
        modalSearchInput.focus();
        renderCurrencyList(availableCurrencies);
      }

      function closeCurrencyModal() {
        // Restore body scrolling when modal is closed
        document.body.style.overflow = '';
        document.documentElement.style.overflow = '';
        
        currencyModal.style.display = 'none';
        searchBackdrop.style.display = 'none';
        currentSearchType = null;
        currentSearchInput = null;
      }

      function renderCurrencyList(currencies) {
        modalCurrencyList.innerHTML = currencies.map((currency, index) => `
          <div class="suggestion-item" data-currency="${currency.code}" data-name="${currency.name}" data-flag="${currency.flag}" style="animation-delay: ${index * 0.02}s">
            <img class="suggestion-flag" src="https://flagcdn.com/20x15/${currency.flag}.png" alt="${currency.name} flag" onerror="this.src='https://flagcdn.com/20x15/un.png'">
            <div class="suggestion-text">
              <div class="suggestion-code">${currency.code}</div>
              <div class="suggestion-name">${currency.name}</div>
            </div>
          </div>
        `).join('');
      }
      
      // Enhanced search functionality
      function searchCurrencies(query) {
        if (!query.trim()) {
          renderCurrencyList(availableCurrencies);
          return;
        }
        
        const filtered = availableCurrencies.filter(currency => 
          currency.code.toLowerCase().includes(query.toLowerCase()) ||
          currency.name.toLowerCase().includes(query.toLowerCase())
        );
        
        renderCurrencyList(filtered);
      }

      function selectCurrency(code, name, flag) {
        if (currentSearchInput) {
          const fullName = `${code} - ${name}`;
          currentSearchInput.value = fullName;
          currentSearchInput.setAttribute('data-currency', code);
          currentSearchInput.setAttribute('data-full-name', fullName);
          
          // Update flag
          const flagImg = currentSearchInput.parentElement.querySelector('.flag-indicator');
          if (flagImg) {
            flagImg.src = `https://flagcdn.com/48x36/${flag}.png`;
            flagImg.alt = `${name} flag`;
          }
          
          // Update global currency variables and call main.js function
          if (window.CurrencyConverter && window.CurrencyConverter.selectCurrency) {
            const currency = { code: code, name: name, country: flag };
            const isFromInput = currentSearchType === 'from';
            console.log(`ðŸ”„ Modal selecting currency: ${code} for ${isFromInput ? 'FROM' : 'TO'}`);
            window.CurrencyConverter.selectCurrency(currency, isFromInput);
          } else {
            console.error('âŒ window.CurrencyConverter.selectCurrency not available');
            // Fallback: directly update global variables
            if (currentSearchType === 'from') {
              window.currentFromCurrency = code;
            } else {
              window.currentToCurrency = code;
            }
            console.log(`ðŸ”„ Fallback: Set ${currentSearchType} currency to ${code}`);
          }
        }
        closeCurrencyModal();
      }

      // Event listeners
      document.addEventListener('click', (e) => {
        if (e.target.closest('.search-input-container') && currencyModal.style.display !== 'flex') {
          const container = e.target.closest('.search-input-container');
          const type = container.getAttribute('data-type');
          const input = container.querySelector('.currency-search');
          openCurrencyModal(type, input);
        }
        
        if (e.target.closest('.suggestion-item')) {
          const item = e.target.closest('.suggestion-item');
          const code = item.getAttribute('data-currency');
          const name = item.getAttribute('data-name');
          const flag = item.getAttribute('data-flag');
          selectCurrency(code, name, flag);
        }
        
        // ONLY allow closing via X button - block all other methods
        if (e.target.closest('.modal-close-btn')) {
          closeCurrencyModal();
        }
      });
      
      // Add search input event listener
      modalSearchInput.addEventListener('input', (e) => {
        searchCurrencies(e.target.value);
      });
      
      // Load currencies when page loads
      document.addEventListener('DOMContentLoaded', () => {
        loadCurrencies();
      });  
      
      // Prevent any other clicks from closing modal
      document.addEventListener('click', (e) => {
        if (currencyModal.style.display === 'flex') {
          e.preventDefault();
          e.stopPropagation();
        }
      });

      // Search functionality
      modalSearchInput.addEventListener('input', (e) => {
        const query = e.target.value.toLowerCase();
        const filtered = sampleCurrencies.filter(currency => 
          currency.code.toLowerCase().includes(query) ||
          currency.name.toLowerCase().includes(query)
        );
        renderCurrencyList(filtered);
      });

      // Keyboard navigation - DISABLE ESC key closing
      document.addEventListener('keydown', (e) => {
        if (currencyModal.style.display === 'flex') {
          // Block ESC key from closing modal
          if (e.key === 'Escape') {
            e.preventDefault();
            e.stopPropagation();
          }
        }
      });

      // Auto-clean functionality for currency inputs
      document.addEventListener('focusin', (e) => {
        if (e.target.classList.contains('currency-search') && currencyModal.style.display !== 'flex') {
          const originalValue = e.target.getAttribute('data-full-name');
          e.target.setAttribute('data-original-value', originalValue || e.target.value);
          e.target.value = '';
          e.target.removeAttribute('readonly');
        }
      });

      document.addEventListener('focusout', (e) => {
        if (e.target.classList.contains('currency-search') && currencyModal.style.display !== 'flex') {
          if (!e.target.value.trim()) {
            const originalValue = e.target.getAttribute('data-original-value');
            e.target.value = originalValue || e.target.getAttribute('data-full-name') || '';
          }
          e.target.setAttribute('readonly', 'true');
        }
      });

      // Restrict all inputs when modal is open
      document.addEventListener('keydown', (e) => {
        if (currencyModal.style.display === 'flex') {
          // Only allow input in the modal search field and close button
          if (!e.target.closest('.currency-search-modal') && e.target.id !== 'modal-search-input' && !e.target.closest('.modal-close-btn')) {
            e.preventDefault();
            e.stopPropagation();
          }
        }
      });

      document.addEventListener('input', (e) => {
        if (currencyModal.style.display === 'flex') {
          // Only allow input in the modal search field
          if (!e.target.closest('.currency-search-modal') && e.target.id !== 'modal-search-input') {
            e.preventDefault();
            e.stopPropagation();
          }
        }
      });

      // Block all touch/pointer events outside modal except X button
      document.addEventListener('touchstart', (e) => {
        if (currencyModal.style.display === 'flex') {
          if (!e.target.closest('.currency-search-modal') && !e.target.closest('.modal-close-btn')) {
            e.preventDefault();
            e.stopPropagation();
          }
        }
      });

      document.addEventListener('pointerdown', (e) => {
        if (currencyModal.style.display === 'flex') {
          if (!e.target.closest('.currency-search-modal') && !e.target.closest('.modal-close-btn')) {
            e.preventDefault();
            e.stopPropagation();
          }
        }
      });
    </script>
</body>
</html>